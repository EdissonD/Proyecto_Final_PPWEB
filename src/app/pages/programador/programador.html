<app-menu></app-menu>

<div class="programador-container">
  <h1>Panel de Programador</h1>

  <!-- Caso: no hay usuario -->
  <div *ngIf="!usuario">
    <p>Debes iniciar sesión como programador para gestionar tus proyectos.</p>
  </div>

  <!-- Caso: logueado pero el token no trae idProgramador -->
  <div *ngIf="usuario && !(usuario?.idProgramador || usuario?.programadorId)" class="alerta">
    <p>
      Estás logueado, pero tu token no incluye el identificador del programador.
      Si tu backend no expone un endpoint tipo <code>/api/proyectos/mis</code>,
      necesitarás que el backend derive el programador desde el usuario autenticado.
    </p>
  </div>

  <!-- Caso: ok -->
  <div *ngIf="usuario && (usuario?.idProgramador || usuario?.programadorId)">

    <h2>Mis proyectos</h2>

    <button type="button" (click)="nuevoProyecto()">
      Nuevo proyecto
    </button>

    <div *ngIf="cargando">
      Cargando proyectos...
    </div>

    <table *ngIf="!cargando && proyectos.length > 0">
      <thead>
        <tr>
          <th>Título</th>
          <th>Tecnologías</th>
          <th>Links</th>
          <th>Acciones</th>
        </tr>
      </thead>

      <tbody>
        <tr *ngFor="let p of proyectos; trackBy: trackByProyecto">
          <td>{{ p.titulo }}</td>
          <td>{{ p.tecnologias }}</td>
          <td>
            <a *ngIf="p.urlRepo" [href]="p.urlRepo" target="_blank" rel="noopener">Repo</a>
            <span *ngIf="p.urlRepo && p.urlDemo"> | </span>
            <a *ngIf="p.urlDemo" [href]="p.urlDemo" target="_blank" rel="noopener">Demo</a>
          </td>
          <td>
            <button type="button" (click)="editarProyecto(p)">Editar</button>
            <button type="button" (click)="eliminarProyecto(p)">Eliminar</button>
          </td>
        </tr>
      </tbody>
    </table>

    <p *ngIf="!cargando && proyectos.length === 0">
      Aún no tienes proyectos registrados.
    </p>

    <!-- Formulario para crear/editar proyectos -->
    <div class="proyecto-form" *ngIf="modo === 'nuevo' || modo === 'editar'">

      <h3 *ngIf="modo === 'nuevo'">Nuevo proyecto</h3>
      <h3 *ngIf="modo === 'editar'">Editar proyecto</h3>

      <form [formGroup]="form" (ngSubmit)="guardarProyecto()">

        <div>
          <label>Título del proyecto</label>
          <input type="text" formControlName="titulo">
        </div>

        <div>
          <label>Descripción</label>
          <textarea rows="4" formControlName="descripcion"></textarea>
        </div>

        <div>
          <label>Tecnologías utilizadas</label>
          <input type="text" formControlName="tecnologias" placeholder="Angular, Spring Boot, PostgreSQL...">
        </div>

        <div>
          <label>Repositorio</label>
          <input type="url" formControlName="urlRepo" placeholder="https://github.com/...">
        </div>

        <div>
          <label>Demo / despliegue</label>
          <input type="url" formControlName="urlDemo" placeholder="https://...">
        </div>

        <button type="submit" [disabled]="cargando || form.invalid">
          {{ cargando ? 'Guardando...' : 'Guardar' }}
        </button>

        <button type="button" (click)="cancelarEdicion()">
          Cancelar
        </button>

      </form>
    </div>
  </div>
</div>
